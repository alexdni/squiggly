[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
user=root

[program:postgresql]
command=/usr/lib/postgresql/15/bin/postgres -D /data/postgres
user=postgres
autostart=true
autorestart=true
priority=10
stdout_logfile=/var/log/supervisor/postgresql.log
stderr_logfile=/var/log/supervisor/postgresql-error.log
environment=PGDATA="/data/postgres"

[program:python-worker]
command=gunicorn --bind 0.0.0.0:8000 --workers 2 --timeout 600 server:app
directory=/app/api/workers
autostart=true
autorestart=true
priority=20
startsecs=10
startretries=3
stdout_logfile=/var/log/supervisor/python-worker.log
stderr_logfile=/var/log/supervisor/python-worker-error.log
environment=PYTHONUNBUFFERED="1",STORAGE_MODE="local",STORAGE_PATH="/data/storage",DATABASE_URL="postgresql://squiggly:squiggly@localhost:5432/squiggly"

[program:nextjs]
command=npm start
directory=/app
autostart=true
autorestart=true
priority=30
startsecs=10
startretries=3
stdout_logfile=/var/log/supervisor/nextjs.log
stderr_logfile=/var/log/supervisor/nextjs-error.log
environment=NODE_ENV="production",PORT="3000",DEPLOYMENT_MODE="docker",DATABASE_MODE="postgres",STORAGE_MODE="local",AUTH_MODE="local",DATABASE_URL="postgresql://squiggly:squiggly@localhost:5432/squiggly",WORKER_SERVICE_URL="http://localhost:8000",STORAGE_PATH="/data/storage"

[program:admin-setup]
command=/bin/bash -c "sleep 10 && node /app/scripts/create-admin.js"
autostart=true
autorestart=false
startsecs=0
priority=40
stdout_logfile=/var/log/supervisor/admin-setup.log
stderr_logfile=/var/log/supervisor/admin-setup-error.log
environment=DATABASE_URL="postgresql://squiggly:squiggly@localhost:5432/squiggly"

[eventlistener:supervisor_events]
command=/bin/bash -c "while read line; do echo $line; done"
events=PROCESS_STATE
buffer_size=10
